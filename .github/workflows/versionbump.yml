name: Version Bump

on:
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      branch:
        required: true
        type: string
    secrets:
      GH_ACCESS:
        required: true

jobs:
  version-bump:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_ACCESS }}
        fetch-depth: 2

    - uses: actions/checkout@v3
      with:
        repository: BigGeo-GIV/bg-ci
        ref: main
        path: bg-ci
        token: ${{ secrets.GH_ACCESS }}

    - name: Check for manual version change
      id: check
      run: |
        if git diff --name-only HEAD^ HEAD | grep version.json; then
          echo version and source changed: no need to bump
        else
          echo "GO=1" >> $GITHUB_OUTPUT
        fi

    - name: Install Python
      if: steps.check.outputs.GO
      uses: actions/setup-python@v4
      with: { python-version: "3.10" }

    - name: Bump version
      if: steps.check.outputs.GO
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        prevMsg=$(git log -1 --pretty=%B)

        dev=1
        if [ ${{ github.ref }} = refs/heads/main ]; then
          dev=0
        fi

        if python3 bg-ci/BumpVersion.py "${prevMsg}" ${{ inputs.name }} ${dev}; then
          git add version.json
          newVer=$(python3 bg-ci/GetVersion.py ${{ inputs.name }} ${dev})
          newMsg="v""${newVer}"" - ""${prevMsg}"
          git commit -m "${newMsg}"
          git pull
        else
          echo "GO=0" >> $GITHUB_OUTPUT
        fi

    - name: Push changes
      if: steps.check.outputs.GO
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GH_ACCESS }}
        branch: ${{ inputs.branch }}
