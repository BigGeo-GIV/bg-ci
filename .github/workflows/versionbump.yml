name: Version Bump

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
    secrets:
      GH_ACCESS:
        required: true

jobs:
  version-bump:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_ACCESS }}
        fetch-depth: 2

    - name: Check for manual version change
      run: |
        if git diff --name-only HEAD^ HEAD | grep version.txt; then
          echo version and source changed: aborting
          exit 1
        fi

    - name: Install Python
      uses: actions/setup-python@v4
      with: { python-version: "3.8" }

    - name: Bump version
      run: |
        python3 BumpVersion.py
        git config --local user.email "benjaminu+ci@vividtheory.com"
        git config --local user.name "version bumper"
        git add .
        prevMsg=$(git log -1 --pretty=%B)
        newVer=$(cat version.txt)
        newMsg="${prevMsg}"" -> ""${newVer}"
        git commit -m "${newMsg}"
        git pull

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GH_ACCESS }}
        branch: ${{ inputs.branch }}

    # - env:
    #     GH_TOKEN: ${{secrets.GH_ACCESS}}
    #   run: gh workflow run ci.yml --ref version-testing
